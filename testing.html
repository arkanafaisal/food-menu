<!DOCTYPE html>

<html>
<head>
  <meta http-equiv="CONTENT-TYPE" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Hello, World!</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
  </style>
</head>
<body class="font-sans">
  <nav class="bg-[#F7F7F7] sticky top-0 py-1 px-6 shadow-md flex justify-between items-center z-100">
    <div class="flex gap-1 items-center">
      <svg class="h-12" fill="#FFC107" viewBox="0 0 24.00 24.00" xmlns="http://www.w3.org/2000/svg" stroke="#FFC107" stroke-width="0.00024000000000000003"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="M3,7C3,4.239,4.791,2,7,2s4,2.239,4,5a4.913,4.913,0,0,1-3,4.823V21a1,1,0,0,1-2,0V11.823A4.913,4.913,0,0,1,3,7ZM19,3V7H18V3a1,1,0,0,0-2,0V7H15V3a1,1,0,0,0-2,0V8a3,3,0,0,0,3,3V21a1,1,0,0,0,2,0V11a3,3,0,0,0,3-3V3a1,1,0,0,0-2,0Z"></path></g></svg>
      <h1 id='company' class="text-2xl text-[#333333]">14:56</h1>
    </div>
    <div class="flex items-center">
      <button class="relative" onclick="toggleCart()">
        <svg class="h-10" viewBox="0 0 24.00 24.00" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#FFC107"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M21 5L19 12H7.37671M20 16H8L6 3H3M11.5 7L13.5 9M13.5 9L15.5 7M13.5 9V3M9 20C9 20.5523 8.55228 21 8 21C7.44772 21 7 20.5523 7 20C7 19.4477 7.44772 19 8 19C8.55228 19 9 19.4477 9 20ZM20 20C20 20.5523 19.5523 21 19 21C18.4477 21 18 20.5523 18 20C18 19.4477 18.4477 19 19 19C19.5523 19 20 19.4477 20 20Z" stroke="#FFC107" stroke-width="1.9200000000000004" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
        <div class="hidden absolute translate-y-1/2 -translate-x-1/2 bottom-0 left-1/2">
          <span id="cart-notification" class="inline-block whitespace-nowrap px-[3px] rounded-xl bg-red-500 text-white text-xs">0 baru!</span>
        </div>
      </button>
    </div>
  </nav>
  
  
  <div id="shopping-cart" class="hidden p-2 flex flex-col justify-center py-4">
    <button class="py-1 px-2 bg-[#E0E0E0] rounded-md w-fit mx-auto" onclick="toggleCart()">kembali ke menu</button>
    
    <div id="cart-container" class="border-1 mt-5 py-2 px-3 bg-black/4 rounded-md">
      <h1 class="text-center text-2xl mb-5">Keranjang Belanja</h1>
      <h2 class="text-xl">barang:</h2>
      <ul id="cart-item-list" class="flex flex-col gap-2 min-h-[200px]">
        <!-- cart-item-list-node -->
        
      </ul>
      <div id="total-price-container" class="flex gap-2 text-xl">
        <h2>total harga: </h2>
        <h2 id="total-price">0</h2>
      </div>
    </div>
    <button class="bg-green-500 w-full text-center text-xl py-1 mt-3 rounded-lg" onclick='makeOrder()'>Buatkan Pesanan</button>
    
    <textarea id='textarea'></textarea>
  </div>
  
  
  <main id="page-main" class="mt-1">
    <section class="flex flex-col items-center px-3 mt-6 py-8" id="hero-section">
      <h1 id="hero-text" class="text-5xl ml-3 text-[#333333] mb-3"> Laper? Cek Danus Dulu ðŸ˜‹</h1>
      
      <svg id="hero-image" class="h-64" version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512.00 512.00" xml:space="preserve" fill="#FFC107" stroke="#FFC107" stroke-width="1.024"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <style type="text/css">  .st0{fill:#FFC107;}  </style> <g> <polygon class="st0" points="30.922,460.156 481.094,460.156 481.094,421.969 30.922,431 "></polygon> <polygon class="st0" points="30.922,499.641 481.094,508.688 481.094,470.484 30.922,470.484 "></polygon> <path class="st0" d="M153.094,340.672v22.016c0,22.844,46.078,41.375,102.906,41.375s102.906-18.531,102.906-41.375v-22.016 C449.047,301.063,512,211,512,106.219C512,49.391,397.391,3.313,256,3.313C114.625,3.313,0,49.391,0,106.219 C0,211,62.969,301.063,153.094,340.672z M41.828,106.219c0-2.234,8.984-17.984,48.75-33.953 C133.469,55.031,193.75,45.141,256,45.141s122.531,9.891,165.438,27.125c39.75,15.969,48.734,31.719,48.734,33.953 s-8.984,17.969-48.734,33.953C378.531,157.406,318.25,167.297,256,167.297s-122.531-9.891-165.422-27.125 C50.813,124.188,41.828,108.453,41.828,106.219z"></path> </g> </g></svg>
      
    </section>
    
    <section id="menu" class="flex flex-col px-3 py-6 bg-[#E0E0E0] min-h-100">
      <div id="notice-container" class="hidden px-5 py-2 bg-white max-w-[70%] mx-auto rounded-xl mb-3">
        <h2 id="notice-header" class="text-xl text-center text-red-500 mb-1">Notice!</h2>
        <p id="notice-text" class="text-sm text-center mx-auto">blablabla blu blu blu lorem ipsum dolores</p>
      </div>
      
      
      <h2 class="text-3xl ml-3 mb-3">Menu:</h2>
      <ul id="menu-list" class="flex flex-col items-center gap-3">
        <!-- menu-list-node -->
      </ul>
      <h2 id="loading-indicator" class="w-full text-center text-xl">loading...</h2>
    </section>
  </main>
  
  
  <footer id="page-footer" class="py-3">
    <h1 id="" class="text-center text-2xl mb-1">ada pertanyaan?</h1>
    <div id="contact-container" class="w-full overflow-x-auto ">
      <ul id="contact-list" class="w-full flex gap-3 px-1 justify-center">
        <!-- contact-node -->
      </ul>
    </div>
  </footer>
  
  
  <template id="template-node">
    
    <li id="menu-list-node" class="hidden bg-[#F7F7F7] flex flex-col w-[90%] px-5 py-2 rounded-md shadow-md">
      <img id="image" class="max-w-[calc(100%-20px)] max-h-64 min-h-32 mx-auto" alt="tidak ada gambar">
      <h3 id="name" class="text-3xl mb-1 text-center"></h3>
      <div id="detail" class="additional-info overflow-hidden max-h-0 transition-all duration-300">
        <div id="detail-text">
          <h3 id="price" class="text-xl transition-colors duration-300 ease-out"></h3>
          <h3 id="stock" class="text-xl"></h3>
          <h3 id="read-menu-detail" class="hidden text-xl"></h3>
          <div id="select-menu-detail" class="hidden flex gap-1 my-1">
            <h3 class="text-xl"></h3>
            <div class="selectable-detail-container flex flex-wrap gap-1">
              <button id="selectable-detail-btn" class="hidden rounded-lg text-md px-1 bg-black/20 border-1"></button>
            </div>
          </div>   
        </div>
        <button id="place-order-button" class="bg-green-500 w-full px-2 py-1 text-md mt-2 rounded-sm" onclick="addOrder(this)">tambah ke keranjang</button>
      </div>
    </li>
    
    <li id="error-menu" class="bg-white px-3 py-2 flex flex-col items-center rounded-lg">
      <h1 class="text-red-500 mb-3">error</h1>
      <button class="bg-blue-500 text-white px-2 py-1 w-fit rounded-lg">try again</button>
    </li>
    
    <li id="cart-item-list-node" class="hidden flex flex-row items-start flex-wrap justify-between">
      <ul id="cart-item-detail-node" class="flex flex-grow flex-wrap max-w-[80%] gap-1">
        <li id="same-order-total" class="border-1 border-black rounded-lg px-1 bg-black/50 text-white">1</li>
        <li id="cart-item-name" class="border-1 border-[#FFC107] rounded-lg px-1 bg-[#FFC107]/50"></li>
        <li id="cart-item-variant" class="border-1 border-red-500 rounded-lg px-1 bg-red-500/50"></li>
        <li id="cart-item-extra" class="hidden border-1 border-green-500 rounded-lg px-1 bg-green-500/50"></li>
      </ul>
      <button class="px-1 h-fit border-1 border-black bg-black/50 rounded-lg text-white" onclick='removeItem(this)'>hapus</button>
    </li>
    
    
    <li id="contact-node" class="shrink-0">
      <button class="bg-green-500 w-fit px-1 rounded-2xl flex items-center">
        <img class="h-6 my-auto" src="./data/image/whatsapp.svg"><span class="text-black/80 text-lg inline-block">fadhil</span>
      </button>
    </li>
    
  </template>

  
  
  

<script>
alert('debug 4.2')

const template = document.getElementById('template-node')


  
const essentialData = {}
mainFunction()

async function mainFunction(){
  initiateEssentialData()
  
  const dataUrl = "https://docs.google.com/spreadsheets/d/1HnxPabYY0sNdeSYl8dzEEHXCg-9f0Royk3DK0s_uDWo/export?format=csv"
  let data, errorMessage
  try{
    const response = await fetch(dataUrl)
    data = await response.text()
    data = Papa.parse(data).data
  } catch(error){
    errorMessage = error.message
  }
  
  document.getElementById('loading-indicator').classList.add('hidden')
  if(errorMessage){
    const errorNode = template.content.getElementById('error-menu').cloneNode(true)
    errorNode.children[0].textContent = errorMessage
    errorNode.children[1].onclick = ()=>{
      document.getElementById('loading-indicator').classList.remove('hidden')
      document.getElementById('error-menu').remove()
      mainFunction()
    }
    menuList.appendChild(errorNode)
    return
  }

  
  let dataCleaned = []
  for(let i=0; i<data.length; i++){
    const current = data[i]
    if(i === 1){
      essentialData.company = current[0]
      essentialData.slogan = current[1]
      essentialData.prefilledGform = current[2]
      essentialData.contactPerson = current[3].split(',').map(val => val.trim().replace(/\)/g, '').split('('))
      essentialData.noticeText = current[4]
      
      initiateEssentialData(essentialData)
      continue
    }
    if(i < 4){continue}
      
    let dataObject = {}
    dataObject.name = current[0]
    dataObject.stock = current[1]
    dataObject.image = '' 
    let imgLinkStartId = current[2].indexOf('/d/')
    if(imgLinkStartId !== -1){
      let imgLinkId = current[2].slice(imgLinkStartId + 3, current[2].indexOf('/view'))
      let imgUrl = 'https://drive.google.com/thumbnail?id=' + imgLinkId
      dataObject.image = imgUrl
    }
    dataObject.price = current[3].split(',').map(val => val.trim())
    
    let extras = []
    for(j=4; j<current.length; j++){
      if(current[j] === '') continue
      
      let extra = current[j].split('=')
      dataObject[extra[0].trim()] = extra[1].split('/').map(val => val.trim())
    }
      
    dataCleaned.push(dataObject)
  }
    dataCleaned.sort((a,b) => {
      if(a.stock === 'habis' && b.stock === 'tersedia'){return 1}
      if(a.stock === 'tersedia' && b.stock === 'habis'){return -1}
      return 0
    })
    
  initiateMainData(dataCleaned)
}
  
function initiateEssentialData(data){
alert(1)
return
  if(data !== undefined){
    alert(JSON.stringify(data))
    localStorage.setItem('company', data.company)
    localStorage.setItem('slogan', data.slogan)
    localStorage.setItem('noticeText', data.noticeText)
  }
  
 alert(2) document.getElementById('company').textContent = localStorage.getItem('company') || 'YourFood'
  document.getElementById('hero-text').textContent = localStorage.getItem('slogan') || 'Nanti Makan Apa? Pesan Sekarang!'
 
alert(3) document.getElementById('notice-text').textContent = localStorage.getItem('noticeText')
  if(localStorage.getItem('noticeText').trim() !== ''){
alert(3.5)
    document.getElementById('notice-text').parentElement.classList.remove('hidden')
  }
  
  if(data !== undefined && data.contactPerson[0] !== ''){
alert(4)
    data.contactPerson.forEach(item => {
      const newNode = template.content.getElementById('contact-node').cloneNode(true)
      newNode.children[0].children[1].textContent = item[0]
      newNode.children[0].onclick = () => {
        const linkWa = 'https://wa.me/' + item[1]
        window.open(linkWa, '_blank')
      }
      
     alert(5) document.getElementById('contact-list').appendChild(newNode)
    })
  }
}
  
 
const menuList = document.getElementById("menu-list")
const menuListNode = template.content.getElementById("menu-list-node")
let menuListNodeWidth = (menuList.offsetWidth * 0.7) + 'px'
  
function initiateMainData(data){
  const fragment = document.createDocumentFragment()
  data.forEach(menuData => {
    const newNode = menuListNode.cloneNode(true)
    newNode.onclick = () => {changeMenuSelected(newNode, event)}
    newNode.classList.remove('hidden')
  
    const nodeChildren = newNode.children
    nodeChildren[0].src = menuData.image
    nodeChildren[0].alt = 'gambar ' + menuData.name
    nodeChildren[0].style.maxWidth = menuListNodeWidth
    nodeChildren[1].textContent = menuData.name
    newNode.dataset['name'] = menuData.name
  
    const detailsChildren = newNode.querySelector('#detail-text').children
    detailsChildren[1].textContent = "stok: " + menuData.stock
    detailsChildren[0].textContent = "harga: " + menuData.price[0]
    newNode.dataset['price'] = menuData.price[0]
    
    if(menuData.stock === 'habis'){
      newNode.classList.add('opacity-50')
      const button = nodeChildren[2].children[1]
      button.classList.remove('bg-green-500')
      button.classList.add('bg-gray-400')
      button.onclick = null
    }
  
    const keys = Object.keys(menuData)
    for(let i=4; i<keys.length; i++){
      const newDetail = template.content.getElementById('select-menu-detail').cloneNode(true)
      newDetail.classList.remove('hidden')
      
      newDetail.children[0].textContent = keys[i] + ': '
      newDetailBtnContainer = newDetail.children[1]
      newDetail.id = 'select-menu-detail-' + i
    
      for(let j=0; j<menuData[keys[i]].length; j++){
        const newSelectableDetail = newDetailBtnContainer.children[0].cloneNode()
        newSelectableDetail.classList.remove('hidden')
        
        newSelectableDetail.textContent = menuData[keys[i]][j]
        newSelectableDetail.id = newNode.dataset['name'].replace(/\s+/g, "") + '-item-detail-' + keys[i] + '-' + j
        newDetailBtnContainer.appendChild(newSelectableDetail)
      
        newSelectableDetail.onclick = () => {
          let oldSelected = newSelectableDetail.parentElement.querySelector('.selected')
          oldSelected.classList.remove('selected', 'bg-blue-500/50')
          
          newSelectableDetail.classList.add('selected', 'bg-blue-500/50')
          newNode.dataset['extra' + i] = newSelectableDetail.textContent
          
          if(i === 4 && menuData.price.length > 1 && menuData.price.length > newSelectableDetail.id.at(-1)){
            detailsChildren[0].textContent = "harga: " + menuData.price[newSelectableDetail.id.at(-1)]
            newNode.dataset['price'] = menuData.price[newSelectableDetail.id.at(-1)]
            detailsChildren[0].classList.add('text-red-500')
            setTimeout(() => {detailsChildren[0].classList.remove('text-red-500')}, 300)
          }
        }
      }
      newDetailBtnContainer.children[1].classList.add('selected', 'bg-blue-500/50')
      newNode.dataset['extra' + i] = menuData[keys[i]][0]
 
      nodeChildren[2].children[0].appendChild(newDetail)
    }
  
    newNode.dataset.extraLength = keys.length
    fragment.appendChild(newNode)
  })
  
  menuList.appendChild(fragment)
  menuList.children[0].classList.add('border-3', 'border-[#FFC107]', 'menu-selected')
  const firstListDetail = menuList.children[0].children[2]
  firstListDetail.style.maxHeight = firstListDetail.scrollHeight + 100 + "px"
}
  

  
function changeMenuSelected(newSelected, event) {
  oldSelected = document.querySelector(".menu-selected")
  if(oldSelected){
    oldSelected.classList.remove('border-3', 'border-[#FFC107]', 'menu-selected')
    oldSelected.children[2].style.maxHeight = 0
  }
  if(event.target.tagName !== 'BUTTON' && oldSelected === newSelected){return}
  
  newSelected.classList.add('border-3', 'border-[#FFC107]', 'menu-selected')
  const detail = newSelected.children[2]
  detail.style.maxHeight = detail.scrollHeight + "px"
}
  
  
const cartItemList = document.getElementById("cart-item-list")
const cartItemListNode = template.content.getElementById('cart-item-list-node')
const cartNotif = document.getElementById("cart-notification")
const totalPrice = document.getElementById('total-price')
function addOrder(element){
  const parent = element.parentElement
  const rootParent = parent.parentElement
  const itemDetail = parent.children[0].children
  
  const newItem = cartItemListNode.cloneNode(true)
  newItem.classList.remove('hidden')
  const children = newItem.children[0].children
  
  let itemSelectedData = parent.id + "-" + itemDetail[0].textContent.split(' ')[1] + "-"
  children[1].textContent = rootParent.dataset['name']
  children[2].textContent = rootParent.dataset['price']
  totalPrice.textContent = parseInt(totalPrice.textContent) + parseInt(rootParent.dataset['price']) + 'k'
  
  const extraDetailNode = children[3]
  for(i=4;i<rootParent.dataset.extraLength;i++){
    const newDetail = extraDetailNode.cloneNode()
    newDetail.classList.remove('hidden')
    
    
    newDetail.textContent = rootParent.dataset['extra' + i]
    itemSelectedData += (rootParent.dataset['extra' + i] + '-')
    
    newItem.children[0].appendChild(newDetail)
  }
    
  const existItemList = document.getElementById(itemSelectedData)
  if(existItemList){
    existItemList.children[0].children[0].textContent = parseInt(existItemList.dataset.orderCount) + 1
    existItemList.dataset.orderCount = parseInt(existItemList.dataset.orderCount) + 1

    cartNotif.parentElement.classList.remove('hidden')
    cartNotif.textContent = (parseInt(cartNotif.textContent) + 1) + ' baru!'
    return
  }  
    
  newItem.id = itemSelectedData
  newItem.dataset.orderCount = 1
  cartItemList.appendChild(newItem)
  
  const hr = document.createElement('hr')
  cartItemList.appendChild(hr)
    
  cartNotif.parentElement.classList.remove('hidden')
  cartNotif.textContent = (parseInt(cartNotif.textContent) + 1) + ' baru!'
}
  
function removeItem(el){
  const parent = el.parentElement
  removedPrice = parseInt(parent.children[0].children[2].textContent)
  totalPrice.textContent = parseInt(totalPrice.textContent) - removedPrice + 'k'
  
  parent.dataset.orderCount = parseInt(parent.dataset.orderCount) -1
  if(parseInt(parent.dataset.orderCount) === 0){
    parent.nextElementSibling.remove()
    parent.remove()
    return
  }
  
  parent.children[0].children[0].textContent = parent.dataset.orderCount
}
  
function makeOrder(){
  const allOrderNode = cartItemList.children
  if(allOrderNode.length === 0){return}
  
  let allOrderData = []
  let allPriceData = []
  
  for(i=0; i<allOrderNode.length; i+=2){
    current = allOrderNode[i]
    allOrderData.push(
      (current.dataset.orderCount)
      + ' ' + (current.children[0].children[1].textContent)
      + ' ' + (current.id.split('-').slice(2)).join(' ')
    )
    allPriceData.push(current.children[0].children[2].textContent)
  }
    
  allOrderData = allOrderData.join('\n')
  
    
  let newPrefilledGform = ''
  const startIndex = essentialData.prefilledGform.indexOf("entry.")
  
  const firstEntryStartIndex = essentialData.prefilledGform.indexOf('=', startIndex)
  const firstEntryEndIndex = essentialData.prefilledGform.indexOf('&entry', startIndex)
  const secondEntryStartIndex = essentialData.prefilledGform.indexOf('=', firstEntryEndIndex)
    
  newPrefilledGform = essentialData.prefilledGform.slice(0, secondEntryStartIndex+1) + totalPrice.textContent // + data.prefilledGform.slice(secondEntryEndIndex, data.prefilledGform.length)
  newPrefilledGform = newPrefilledGform.slice(0, firstEntryStartIndex+1) + encodeURIComponent(allOrderData)  + newPrefilledGform.slice(firstEntryEndIndex, essentialData.prefilledGform.length)
  
  window.location.href = newPrefilledGform
}
  
  
const shoppingCart = document.getElementById("shopping-cart")
const main = document.getElementById("page-main")
const footer = document.getElementById('page-footer')
function toggleCart(){
  if(main.classList.contains('hidden')){
    main.classList.remove("hidden")
    footer.classList.remove('hidden')
    shoppingCart.classList.add("hidden")
    menuList.scrollIntoView()
    window.scrollBy(0,-120)
    return
  }
  
  main.classList.add("hidden")
  footer.classList.add('hidden')
  shoppingCart.classList.remove("hidden")
  cartNotif.parentElement.classList.add('hidden')
  cartNotif.textContent = 0
}
</script>
</body>
</html>
